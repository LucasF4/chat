<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <%- include('./partials/links-head.ejs'); %>
    <style>
      .online {
        color: green;
        font-weight: bold;
      }

      .offline {
        color: red;
        font-weight: bold;
      }

      .message-input {
        width: 100%;
        margin-right: 10px;
        padding: 1rem;
        border: 1px solid #ccc;
        resize: none;
        border-radius: 5px;
        min-height: 52px;
        font-size: 1rem;
        line-height: 1.5rem;
        font-family: inherit;
        overflow: hidden;
      }

      /* .send-button {
        padding: 10px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      } */

      .mymessage {
        display: flex;
        flex-direction: row-reverse;
        flex-wrap: wrap-reverse;
        margin: 10px;
        font-size: 20px;
        /* float: right; */
      }

      .mymessage2 {
        background-color: rgb(101, 134, 254);
        padding: 10px;
        border-radius: 5px;
        color: white;
      }

      .outhermessage {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        padding: 10px;
        border-radius: 5px;
        margin: 10px;
        font-size: 20px;
        /* float: left; */
      }

      .outhermessage2 {
        background-color: rgb(48, 51, 70);
        padding: 10px;
        border-radius: 5px;
        color: rgb(90, 93, 110);
      }

      /* #username {
        font-weight: bold;
        font-size: 25px;
      } */
    </style>
  </head>
  <body class="bg-gray-200 w-full flex h-screen gap-8 overflow-hidden">
    <header class="bg-white w-[300px] h-full flex flex-col justify-between p-5">
      <nav class="">
        <ul class="flex flex-col gap-2 text-[#949494]">
          <li><a href="">Chats</a></li>
          <li><a href="">Groups</a></li>
          <li><a href=""></a></li>
        </ul>
      </nav>

      <% if(success){ %>
        <div class="flex items-center gap-2 bg-green-500 absolute bottom-16 p-3 text-white login">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M5 12l5 5l10 -10" />
          </svg>
          <p>Login Feito com Sucesso</p>
        </div>
      <% } %>

      <div class="flex flex-col gap-3 border-t pt-8">
        
        <div class="flex items-center gap-4">
          <img class="rounded-full w-[30px] h-[30px] object-cover" src="src/<%= user.image %>" alt="">
          <span>Profile</span>
        </div>
        <div class="flex items-center gap-5">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-settings" width="25" height="25" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z" />
            <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
          </svg>
          <span>Settings</span>
        </div>
        <div class="flex gap-5 items-center">
          <a href="/logout">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-logout" width="25" height="25" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" />
              <path d="M9 12h12l-3 -3" />
              <path d="M18 15l3 -3" />
            </svg>
          </a>
          <a href="/logout">Logout</a>
        </div>
        
      </div>
    </header>
    <main class="bg-white w-full">
      <div class="w-full flex">
        <div class="max-w-[500px] w-full h-screen px-5 bg-[rgb(37,_40,_55)] overflow-auto">
          <h3 class="p-3 text-white">Conversas</h3>
          <% if(friends != undefined || friends != null){ %> <%
          friends.forEach(function(friend){ %>
          <div
            class="friend_id flex items-center gap-2 p-2 hover:cursor-pointer hover:bg-[rgb(29,_31,_43)] mb-2"
            user="<%= friend.name %>"
            data-id="<%= friend._id %>"
            data-src="<%= friend.image %>"
          >
            <div class="relative">
              <img
                class="w-[55px] h-[55px] rounded-full object-cover"
                src="src/<%= friend.image %>"
                alt=""
              />
              <% if(friend.is_online == '1'){ %>
                <div class="bg-green-500 rounded-full border border-white w-4 h-4 absolute bottom-0 right-0" id="<%= friend._id %>-status"></div>
                <% }else{ %>
                <div class="bg-gray-500 rounded-full border border-white w-4 h-4 absolute bottom-0 right-0" id="<%= friend._id %>-status"></div>
                <% } %>
            </div>
            <div class="flex justify-between items-center w-full">
              <p class="text-white"><%= friend.name %></p>
              <div class="flex justify-center items-center w-7 h-7 bg-[rgb(60,_65,_103)] right-0 rounded-full after:content-['0'] text-white"></div>
            </div>
          </div>
          <% }) %> <% }else{ %>
          <p>Não há usuários</p>
          <% } %>
        </div>

        <div class="flex flex-col w-full h-screen bg-[rgb(29,_31,_43)]">
          <div id="username" class="border-l-4 border-[rgb(29,_31,_43)] w-full p-5 bg-[rgb(37,_40,_55)] text-white font-bold hidden">
            <img id="teste">
            <span id="username_name"></span>
          </div>
          <div id="withoutMessage" class="bg-[rgb(29,_31,_43)] h-screen w-full flex justify-center items-center flex-col">
            <img class="w-[500px] h-[500px]" src="/src/images/no_message.png" alt="">
            <p class="flex items-center justify-center text-white text-base">No Message Selected Yet!</p>
          </div>
          <div
            id="chat"
            class="bg-[rgb(29,_31,_43)] overflow-y-auto w-full h-screen"
          ></div>
          <form
            id="chat-form"
            class="w-full bg-[rgb(29,_31,_43)] flex items-center p-[15px]"
          >
            <textarea
              rows="1"
              cols="0"
              style="background-color: rgb(48, 51, 70); border: none; user-select: none; color: white;"
              class="message-input focus:outline-none"
              id="message"
              placeholder="Message..."
              type="text"
            ></textarea>
            <button type="sumit"
                class="p-[10px] bg-[rgb(101,_134,_254)] rounded-[5px] cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-send" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M10 14l11 -11" />
                  <path d="M21 3l-6.5 18a.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a.55 .55 0 0 1 0 -1l18 -6.5" />
                </svg>
            </button>
          </form>
        </div>
      </div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script>
      var user_id = "<%= user._id %>";
      var received_id;
      $(document).ready(function () {
        $("#chat").hide();
        $("#chat-form").hide();

        $(".friend_id").click(function () {
          var id = $(this).attr("data-id");
          var friendProfile = $(this).attr("data-src")
          $("#username").addClass('flex items-center gap-4')
          $("#username_name").text($(this).attr("user"));
          $('#teste').attr('src', 'src/' + friendProfile).addClass('rounded-full w-[43px] h-[43px] object-cover');
          /* $('<img>', {
            id: 'imageProfile',
            class: 'rounded-full w-[40px] h-[40px]',
            src: "src/images/pexels.jpg"
          }).appendTo('#username') */
          received_id = id;
          //$('#nome-client').append('Teste')
          $("#withoutMessage").addClass('hidden')
          $("#username").removeClass('hidden')
          $("#chat").show();
          $("#chat-form").show();
          socket.emit("existsChat", {
            send_id: "<%= user._id %>",
            receive_id: received_id,
          });
        });
      });

      var socket = io({
        auth: {
          token: "<%= user._id %>",
        },
      });

      socket.on("getOnlineUser", function (data) {
        $("#" + data.user_id + "-status").removeClass("bg-gray-500 rounded-full border border-white w-4 h-4 absolute bottom-0 right-0");
        $("#" + data.user_id + "-status").addClass("bg-green-500 rounded-full border border-white w-4 h-4 absolute bottom-0 right-0");
      });

      socket.on("getOfflineUser", function (data) {
        $("#" + data.user_id + "-status").removeClass("bg-green-500 rounded-full border border-white w-4 h-4 absolute bottom-0 right-0");
        $("#" + data.user_id + "-status").addClass("bg-gray-500 rounded-full border border-white w-4 h-4 absolute bottom-0 right-0");
      });

      //Chat save of user
      $("#chat-form").submit(function (event) {
        event.preventDefault();

        var message = $("#message").val();

        $.ajax({
          url: "/save-messages",
          type: "POST",
          data: {
            sender_id: "<%= user._id %>",
            received_id: received_id,
            message: message,
          },
          success: function (response) {
            console.log(response);

            if (response.data.send_id == user_id) {
              var className = "mymessage";
            } else {
              var className = "outhermessage";
            }

            if (response.success) {
              $("#message").val("");
              var chat = response.data.message;
              var html = `
                        <div class="${className}">
                            <div class="${className}2">
                                <h5>${chat}</h5>
                            </div>
                        </div>
                    `;
              $("#chat").append(html);
              scrollChat();
              document.getElementById("message").style.height = "56px";
              socket.emit("newChat", response.data);
            } else {
              alert(response.msg);
            }
          },
        });
      });

      socket.on("loadNewChat", function (res) {
        console.log("------- aqui -------");
        console.log(res);

        if (user_id === res.receive_id && received_id == res.send_id) {
          if (res.send_id == user_id) {
            var className = "mymessage";
          } else {
            var className = "outhermessage";
          }

          let html = `
                    <div class="${className}">
                        <div class="${className}2">
                            <h5>${res.message}</h5>
                        </div>
                    </div>
                `;
          $("#chat").append(html);

          scrollChat();
          //socket.emit('notification', {not: true})
        }
      });

      socket.on("oldChat", function (data) {
        $("#chat").html("");

        var chats = data.chat;
        let html = "";
        console.log(chats);

        for (let i = 0; i < chats.length; i++) {
          console.log("data.send_id: ", chats[i].send_id);
          console.log("user_id: ", user_id);
          if (chats[i].send_id == user_id) {
            var className = "mymessage";
          } else {
            var className = "outhermessage";
          }
          html += `
                    <div class="${className}">
                        <div class="${className}2"><h5>${chats[i]["message"]}</h5></div>
                        <div class="text-white">${chats[i].date_send}</div>
                    </div>
                `;
        }

        $("#chat").append(html);

        scrollChat();
      });

      function scrollChat() {
        $("#chat").animate({
          scrollTop: $("#chat").offset().top + $("#chat")[0].scrollHeight,
        });
      }

      const textarea = document.getElementById("message");

      textarea.addEventListener("input", () => {
        textarea.style.height = "auto"; // Redefine a altura para auto para que a altura seja recalculada corretamente
        textarea.style.height = textarea.scrollHeight + "px"; // Define a altura para a altura do conteúdo
        scrollChat();
      });

      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          
          $("#withoutMessage").removeClass('hidden')
          $("#username").addClass('hidden')
          $("#chat").hide();
          $("#chat-form").hide();

        }
      });
    </script>
  </body>
</html>
